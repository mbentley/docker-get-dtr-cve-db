#!/bin/bash

# abort on error
set -e

# set defaults
CLOBBER_FILE="${CLOBBER_FILE:-false}"
DATABASE_OUTPUT="${DATABASE_OUTPUT:-/data}"
DATABASE_SCHEMA="${DATABASE_SCHEMA:-2}"
DEBUG="${DEBUG:-false}"
LICENSE="${LICENSE:-}"
LICENSE_FILE="${LICENSE_FILE:-/data/docker_subscription.lic}"
VERSION_ONLY="${VERSION_ONLY:-false}"

# check to see if show debug info
if [ "${DEBUG}" = true ] || [ "${DEBUG}" = "1" ]
then
  set -x
fi

# see if either a license file exists or license was passed via env var
if [ ! -f "${LICENSE_FILE}" ] && [ -z "${LICENSE}" ]
then
  echo "Error: Docker EE license was not passed in the LICENSE (${LICENSE}) environment variable"
  exit 1
fi

# write the license to a temp file if it was passed via env var and force override the LICENSE_FILE
if [ -n "${LICENSE}" ]
then
  echo "${LICENSE}" > /tmp/docker_subscription.lic
  LICENSE_FILE="/tmp/docker_subscription.lic"
fi

# generate the necessary values
GEN_TOKEN_OUTPUT="$(/gen_token "${LICENSE_FILE}")"

# strip out the specific values we need
KEY="$(echo "${GEN_TOKEN_OUTPUT}" | jq -r '.["X-DOCKER-KEY-ID"]')"
TOKEN="$(echo "${GEN_TOKEN_OUTPUT}" | jq -r '.["X-DOCKER-TOKEN"]')"
TIMESTAMP="$(echo "${GEN_TOKEN_OUTPUT}" | jq -r '.["X-DOCKER-TIMESTAMP"]')"

# get a download URL for the CVE database
DB_URL="$(curl -s -X GET \
  -H "X-DOCKER-KEY-ID: ${KEY}" \
  -H "X-DOCKER-TOKEN: ${TOKEN}" \
  -H "X-DOCKER-TIMESTAMP: ${TIMESTAMP}" \
  "https://license.enterprise.docker.com/v1/dss/cve-db-updates/0?schema=${DATABASE_SCHEMA}" \
  | jq -r .urls[])"

# figure out what the file name should be
DATABASE_OUTPUT_FILE="$(echo "${DB_URL}" | awk -F '?' '{print $1}' | awk -F '/' '{print $NF}')"

# make sure the database file begins with `rollup`
if [ "$(echo "${DATABASE_OUTPUT_FILE}" | awk -F '-' '{print $1}')" != "rollup" ] && [ "$(echo "${DATABASE_OUTPUT_FILE}" | awk -F '_' '{print $1}')" != "rollup" ]
then
  echo "Error: DATABASE_OUTPUT_FILE (${DATABASE_OUTPUT_FILE}) wasn't what we expected; please file an issue at https://github.com/mbentley/docker-get-dtr-cve-db/issues"
  exit 1
fi

# make sure the database file ends with `tar`
if [ "$(echo "${DATABASE_OUTPUT_FILE}" | awk -F '.' '{print $NF}')" != "tar" ]
then
  echo "Error: DATABASE_OUTPUT_FILE (${DATABASE_OUTPUT_FILE}) wasn't what we expected; please file an issue at https://github.com/mbentley/docker-get-dtr-cve-db/issues"
  exit 1
fi

# check to see if we should just print out the version number or download the tar
if [ "${VERSION_ONLY}" = "true" ]
then
  # output the version only
  echo "${DATABASE_OUTPUT_FILE}" | awk -F '.' '{print $1}' | awk -F '_' '{print $2}'
else
  # verify output directory exists
  if [ ! -d "${DATABASE_OUTPUT}" ]
  then
    echo "Error: ${DATABASE_OUTPUT} is not a directory"
    exit 1
  fi

  # make sure there isn't a file that exists here
  if [ -f "${DATABASE_OUTPUT}/${DATABASE_OUTPUT_FILE}" ] && [ "${CLOBBER_FILE}" = "false" ]
  then
    echo "Error: File ${DATABASE_OUTPUT}/${DATABASE_OUTPUT_FILE} already exists; remove the file and re-run this script or use CLOBBER_FILE"
    exit 1
  fi

  # download the latest CVE database
  echo "Downloading latest CVE database to '${DATABASE_OUTPUT}/${DATABASE_OUTPUT_FILE}'..."
  curl --progress-bar "${DB_URL}" -o "${DATABASE_OUTPUT}/${DATABASE_OUTPUT_FILE}"
  echo -e "done.\\n"
fi

